---
title: "Implementando ICs"
author: "Nazareno"
output:
  html_document:
    theme: readable
    df_print: paged
    toc: yes
  html_notebook:
    fig_width: 7
    theme: readable
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(broom)
library(boot)
library(gridExtra)
theme_set(theme_bw())
```

## Os dados

```{r}
set.seed(12345)

lastfm = read_csv(here::here("data/experimento-lastfm.csv"), 
                  col_types = cols(.default = col_double(), 
                                   user = col_character()))

lastfm = lastfm %>% 
  sample_n(300) %>% 
  select(news, old, mediana_pop)

glimpse(lastfm)
```

## Proporção de artistas novos e popularidade

Utilizaremos ICs para estimar duas métricas sobre os usuários do LastFM em geral durante um período de 6 meses. Em ambos os casos faremos isso a partir de uma amostra de 300 usuários. As duas métricas são: 

1. Qual a proporção de novos artistas em geral escutada por usuários?

```{r}
set.seed(1212)
lastfm <- lastfm %>% 
    mutate(prop_news = news / (news + old))

theta_c = mean(lastfm$prop_news)

repeticoes = 5000 # pelo menos 2000, mas mais não faz mal.

um_bootstrap <- function(x){
  prop_news = x %>% pull(prop_news)
  boot_x <- sample(prop_news,           # amostre dos dados
                   size = NROW(prop_news), # tamanho igual ao recebido
                   replace = TRUE) # aqui é o bootstrap
  return(mean(boot_x))
}

# A REAMOSTRAGEM
reamostragens = tibble(i = 1:repeticoes) %>% 
  mutate(theta_c_s = map_dbl(i, ~ um_bootstrap(lastfm)))

ci_amostragens = reamostragens %>% 
  mutate(erro = theta_c_s - theta_c) %>% 
  mutate(conf.low = theta_c + quantile(erro, .05), 
         conf.high = theta_c + quantile(erro, .95), 
         statistic = theta_c) %>% 
  select(conf.low, statistic, conf.high)
```

```{r}
funcao_theta_boot = function(df, i) {
  df %>%
    slice(i) %>% 
    pull(prop_news) %>%
    mean()
}

booted <- boot(data = lastfm, 
               statistic = funcao_theta_boot, 
               R = 5000)

ci_boot = tidy(booted, 
          conf.level = .95,
          conf.method = "bca",
          conf.int = TRUE) %>% 
    select(conf.low, statistic, conf.high)
```

```{r}
p1 = ci_amostragens %>%
    ggplot(aes(
        x = "",
        y = statistic,
        ymin = conf.low,
        ymax = conf.high
    )) +
    geom_pointrange() +
    geom_point(size = 3) + 
    labs(x = "Código", 
         y = "Proporção de novos artistas")+ 
    ylim(.235, .265)

p2 = ci_boot %>%
    ggplot(aes(
        x = "",
        y = statistic,
        ymin = conf.low,
        ymax = conf.high
    )) +
    geom_pointrange() +
    geom_point(size = 3) + 
    labs(x = "Bootstrap", 
         y = "Proporção de novos artistas") + 
    ylim(.235, .265)

grid.arrange(p1, p2, ncol = 2)
```

2. Para os usuários que gostam muito de música pop (mediana_pop > 5), qual a correlação entre a popularidade mediana dos artistas escutado e a proporção dos artistas escutados que eram novos. 

```{r}
gamma_c <-  lastfm %>% 
  filter(mediana_pop > 5) 

cor(gamma_c, mediana_pop, prop_news, method = "pearson", use = c("complete.obs"))

repeticoes = 5000 # pelo menos 2000, mas mais não faz mal.

um_bootstrap <- function(x){
  prop_news = x %>% pull(prop_news)
  boot_x <- sample(prop_news,           # amostre dos dados
                   size = NROW(prop_news), # tamanho igual ao recebido
                   replace = TRUE) # aqui é o bootstrap
  return(mean(boot_x))
}

# A REAMOSTRAGEM
reamostragens = tibble(i = 1:repeticoes) %>% 
  mutate(theta_c_s = map_dbl(i, ~ um_bootstrap(lastfm)))

ci_amostragens = reamostragens %>% 
  mutate(erro = theta_c_s - theta_c) %>% 
  mutate(conf.low = theta_c + quantile(erro, .05), 
         conf.high = theta_c + quantile(erro, .95), 
         statistic = theta_c) %>% 
  select(conf.low, statistic, conf.high)

```

Crie intervalos com 95% de confiança.